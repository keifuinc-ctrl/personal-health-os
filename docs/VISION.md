# Personal Health OS - ビジョン & 理念

> このドキュメントは、Personal Health OS の不変の理念と原則を定義します。
> 今後の開発・運用において、このドキュメントに立ち返ることで方向性のブレを防ぎます。
> 
> 関連ドキュメント: [AGENTS.md](./AGENTS.md)（開発ルール・ガイドライン）、[DEVELOPMENT_ROADMAP.md](./DEVELOPMENT_ROADMAP.md)（開発手順/ロードマップ）

---

## 🎯 プロジェクト概要

**Personal Health OS（パーソナルヘルスOS）** は、患者（Beneficiary）が自分の健康データを主権的に管理し、外部電子カルテシステムと連携しながら、患者中心の医療・個別化医療・予防医療を実現する個人主権型ヘルスケアOSです。

### プラットフォーム構造

Personal Health OS は、**Beneficiary Platform（患者専用プラットフォーム）** を中心に構成されています：

#### Beneficiary Platform（患者専用プラットフォーム）
- **対象**: 患者、利用者
- **主要機能**: 
  - 自分カルテ（統合健康データ管理）
  - 外部電子カルテシステムとの連携（FHIR、SS-MIX2、HL7等）
  - 健康計画（リスク予測、予防計画）
  - チーム&地域包括ケア
- **アクセス**: `/beneficiary/*` ルート（または `/` ルート）

### 外部カルテ連携アーキテクチャ

Beneficiary Platformは、既存の医療機関の電子カルテシステムと連携することで、以下の価値を提供します：

- **データの集約**: 複数の医療機関からのデータを患者自身が一元管理
- **患者中心の医療**: 患者が自分のデータを所有し、医療提供者と共有
- **個別化医療・予防医療**: AIを活用したリスク予測と予防計画
- **遠隔医療・mHealth**: ウェアラブルデバイスやモバイルアプリとの統合
- **ビッグデータ分析**: 集約されたデータによる医療アウトカムの改善

医療・介護・ウェルネスを横断して活用できる、個人主権型のヘルスケアOSを目指しています。


---

## 💡 中核理念

### 個人主権型データ管理（Self-Sovereign Health Data）

```
「自分の健康データは、自分のもの。」
```

この理念に基づき、以下の3原則を絶対に守ります：

#### 1. データ所有権は常に本人に帰属

- ユーザーのデータはユーザーのもの
- プラットフォームはデータの「管理者」ではなく「保管庫」
- データの削除・エクスポートは常にユーザーの権利

#### 2. Compute to Data（データは動かさない）

- データを外部に送信しない
- 計算・AIをデータの側に送る
- データの移動を最小限に抑える

#### 3. 明示的同意に基づく最小限利用

- 本人の明示的な同意なしにデータを使用しない
- 同意は「目的」「期間」「範囲」を明確に
- 必要最小限のデータのみを使用

### 電子保存の三原則（Electronic Storage Principles）

医療記録の電子保存において、以下の3原則を技術的に実装し、法的要件を満たします：

#### 1. 真正性（Authenticity）

**定義**: 記録が作成された時点で存在し、その後の改ざんがないことを証明できること

**技術的実装**:
- **デジタル署名**: すべての医療記録にタイムスタンプ付きデジタル署名を付与
- **改ざん検知**: ハッシュ値による整合性チェック（SHA-256等）
- **監査ログ**: すべてのデータ操作を不変ログに記録（`audit_log`テーブル）
- **ブロックチェーン技術（将来実装予定）**: 重要な記録の不変性保証（真正性の強化）

**実装場所**:
- `lib/services/audit-log.ts`: 監査ログ機能
- `lib/services/digital-signature.ts`: デジタル署名サービス（新規作成）
- データベーススキーマ：`audit_log`テーブルの拡張

#### 2. 見読性（Readability）

**定義**: 記録を将来にわたって読み取り可能な形式で保存すること

**技術的実装**:
- **標準フォーマット**: FHIR、SS-MIX2、HL7準拠の形式で保存
- **長期保存形式**: PDF/A、XML、JSON（標準化された形式）でのエクスポート
- **メタデータ管理**: データの意味を保持するメタデータの保存（スキーマ情報、バージョン情報等）
- **バージョン管理**: フォーマット変更時の互換性維持（フォーマット変換履歴の保持）

**実装場所**:
- `lib/services/fhir.ts`: FHIR形式のエクスポート/インポート
- `lib/services/ssmix2-parser.ts`: SS-MIX2形式のサポート
- `lib/services/export.ts`: 長期保存形式へのエクスポート機能

#### 3. 保存性（Preservability）

**定義**: 記録を長期間にわたって保存し、必要な時に取り出せること

**技術的実装**:
- **冗長化**: 複数のストレージへのバックアップ（Supabase、Cloudflare R2等）
- **データ移行計画**: 将来の技術変更に対応可能な設計（標準フォーマットへの変換機能）
- **アクセス制御**: 長期保存データへの適切なアクセス管理（ロールベースアクセス制御）
- **データ整合性チェック**: 定期的なデータ検証（ハッシュ値の照合、破損検知）

**実装場所**:
- `lib/services/backup.ts`: バックアップサービス（新規作成）
- `lib/services/data-migration.ts`: データ移行サービス（新規作成）
- データベーススキーマ：バックアップメタデータテーブルの追加

---

## 🛡️ 絶対に守る原則

### プライバシー原則

| 原則             | 説明                                   |
| ---------------- | -------------------------------------- |
| **データ最小化** | 必要なデータのみ収集・保存             |
| **目的限定**     | 収集目的以外でデータを使用しない       |
| **透明性**       | どのデータがどう使われるか常に明示     |
| **ユーザー制御** | 削除・エクスポートは常にユーザーの権利 |

### セキュリティ原則（最重要）

**セキュリティは最優先事項。すべての機能実装においてセキュリティを最優先に考慮する。**

| 原則             | 説明                               |
| ---------------- | ---------------------------------- |
| **暗号化**       | 通信・保存時のデータ暗号化         |
| **アクセス制御** | 認証されたユーザーのみアクセス可能 |
| **監査ログ**     | すべてのデータアクセスを記録       |
| **最小権限**     | 必要最小限の権限のみ付与           |
| **ブロックチェーン技術** | 将来実装予定：重要な記録の不変性保証（真正性の強化） |

### AI/エージェント原則

| 原則           | 説明                         |
| -------------- | ---------------------------- |
| **補助者**     | AIは決定者ではなく補助者     |
| **説明可能性** | AIの提案には根拠を明示       |
| **同意必須**   | 重要な操作には必ず確認       |
| **集計のみ**   | AIは生データにアクセスしない |

---

## 🧩 Personal Health OS が提供する解決（コア機能）

Personal Health OS は、Beneficiary Platform の4つのコア機能で構成され、すべての開発はこれらの機能の実装・改善を最優先とします。

---

## Beneficiary Platform（患者専用プラットフォーム）

### 1. 自分カルテ機能

**目的**: 薬情報、病院受診情報、疾患情報、検査データを一元管理し、外部電子カルテシステムと連携してデータを統合。データ連携とエクスポートに対応。

**実装優先度**: 🔴 **最優先**

**主要機能**:
- **薬情報**: 服用中の薬を記録・管理
- **病院受診情報**: 受診履歴、治療/手術歴の記録・管理
- **疾患情報**: 既往歴・現病歴の記録
- **検査データ**: 検査結果の記録・管理、グラフ表示
- **外部カルテ連携（最重要）**:
  - FHIR対応（FHIR R4、SMART on FHIR）
  - SS-MIX2形式のサポート
  - HL7形式のサポート
  - OAuth 2.0認証による安全な連携
  - 複数の医療機関からのデータ自動取得
  - リアルタイムデータ同期
- **エクスポート**: CSV、FHIR、SS-MIX2、PDF/A形式でのエクスポート
- **手動記録**: カルテから反映されない情報を自分で記録

**データベーススキーマ**:
- 既存の`medication`、`hospital`、`condition`、`test_result`テーブルを活用
- `external_ehr_connection`テーブル（外部カルテ接続情報、新規追加）
- `ehr_sync_log`テーブル（同期履歴、新規追加）

### 2. 健康計画機能

**目的**: 自分カルテの情報（外部カルテ連携データ含む）を元に、AIを活用したリスク予測と予防計画を提供し、個別化医療・予防医療を実現。健康寿命の延伸を支援。

**実装優先度**: 🔴 **最優先**

**主要機能**:
- **リスク予測**: 1〜10年後のリスク予測（様々な疾患やADLなどを表示）
- **予防計画**: リスク予測を元に、運動、睡眠、食事、その他生活における最適プランを立てる
  - 疾患に合わせた計画（例: 内科、精神、神経、血液など）
  - 個別化された推奨事項
- **分析履歴**: 過去の分析結果の保存・参照
- **ビッグデータ分析**: 集約されたデータによる医療アウトカム分析

**データベーススキーマ**:
- 既存の`ai_analysis`テーブルを活用

### 3. チーム&地域包括ケア機能

**目的**: 参加中のグループ管理、新規グループ作成、支援事業所の検索により、地域包括ケアを支援。

**実装優先度**: 🔴 **最優先**

**主要機能**:
- **参加中のグループ**: 現在参加しているグループの一覧・管理
- **すべてのグループ**: カテゴリ検索、ソート、フィルター、AIがカルテの情報を元におすすめ
- **新しくグループを作成**: 新しいグループの作成機能
- **支援事業所を探す**: 自分カルテや基本情報（年齢、住所など）を元に支援事業所を探す
  - 介護施設、居宅介護支援、地域包括、デイサービス、訪問看護、訪問介護、相談支援事業、放課後デイ、共同生活援助、老人ホーム等

**データベーススキーマ**:
- 既存の`group`、`group_member`、`group_post`テーブルを活用
- `care_facility`テーブル（支援事業所情報、新規追加）
- `facility_match`テーブル（マッチング結果、新規追加）

### 4. マイページ機能

**目的**: 通知、設定、プラン管理により、ユーザーが自身のアカウントを管理。

**実装優先度**: 🔴 **最優先**

**主要機能**:
- **通知**: システムからの通知の確認・管理
- **設定**: アカウント設定、通知設定、プライバシー設定、外部カルテ連携設定
- **プラン**: 無料プラン、パートナープランの管理

**データベーススキーマ**:
- 既存の`notification`、`user_setting`、`subscription`テーブルを活用

---

### 開発スキーム

**原則**: すべての開発は、上記のコア機能（Beneficiary Platform 4機能）の実装・改善を最優先とします。

1. **新機能の実装判断**: コア機能の実装・改善に貢献するか？
2. **バグ修正の優先順位**: コア機能のバグを最優先で修正
3. **技術選定**: コア機能の実装に最適な技術を選択
4. **リソース配分**: コア機能の開発に最大限のリソースを配分
5. **電子保存の三原則**: すべての医療記録において、真正性・見読性・保存性を技術的に実装
6. **外部カルテ連携**: FHIR、SS-MIX2、HL7等の標準プロトコルに準拠し、安全な連携を実現
7. **開発環境**: Cursor内のWebビューアを必ず使用（外部ブラウザで開くと制限があり不都合が多いため）
8. **UI/UX重視**: ユーザーが実際に使用するため、UI/UX、アニメーション、3Dなどのフロントエンド部分は重要である
9. **セキュリティ最優先**: セキュリティは最重要事項（いずれはブロックチェーン技術の導入を予定）

### 開発プロセス原則

Personal Health OS の開発は、以下の原則に従います：

#### TDD & Issue駆動開発（必須）

- **原則**: 「コードを書く前に、失敗するテストを書く」
- すべての実装は Issue から始める
- テストを先に書き、テストが通ることを確認してからコミット
- 詳細は [AGENTS.md](./AGENTS.md) の「3. 開発プロセス原則」を参照

#### MCP/CLIを用いたAI駆動開発

- **原則**: 「エージェントはMCPとCLIを活用して、ほとんどの作業を自動実行できる」
- MCP連携可能なツールはMCP Server経由で実行（推奨）
- MCP未対応のツールはCLI経由で実行
- 詳細は [AGENTS.md](./AGENTS.md) の「2.5. エージェント実行環境」を参照

#### 型安全（TypeScript/TSX）

- **原則**: 「型が通らないコードは、存在しないコード」
- `tsconfig.json`: `strict: true` 必須
- コード変更後は必ず `pnpm typecheck` を実行
- 型エラーがある場合は修正してからコミット
- 詳細は [AGENTS.md](./AGENTS.md) の「4. コーディング規約」を参照

---

## ✅ 提供する機能

### Beneficiary Platform コア機能（開発最優先）

#### 1. 自分カルテ機能
- ⏳ **薬情報** - 服用中の薬を記録・管理
- ⏳ **病院受診情報** - 受診履歴、治療/手術歴の記録・管理
- ⏳ **疾患情報** - 既往歴・現病歴の記録
- ⏳ **検査データ** - 検査結果の記録・管理、グラフ表示
- ⏳ **外部カルテ連携（最重要）** - FHIR R4、SMART on FHIR、SS-MIX2、HL7形式のサポート、OAuth 2.0認証、複数医療機関からのデータ自動取得、リアルタイムデータ同期
- ⏳ **エクスポート** - CSV、FHIR、SS-MIX2、PDF/A形式でのエクスポート
- ⏳ **手動記録** - カルテから反映されない情報を自分で記録

#### 2. 健康計画機能
- ⏳ **リスク予測** - 1〜10年後のリスク予測（様々な疾患やADLなど）
- ⏳ **予防計画** - 運動、睡眠、食事、その他生活における最適プラン（疾患別：内科、精神、神経、血液など）、個別化された推奨事項
- ⏳ **分析履歴** - 過去の分析結果の保存・参照
- ⏳ **ビッグデータ分析** - 集約されたデータによる医療アウトカム分析

#### 3. チーム&地域包括ケア機能
- ⏳ **参加中のグループ** - 現在参加しているグループの一覧・管理
- ⏳ **すべてのグループ** - カテゴリ検索、ソート、フィルター、AIおすすめ
- ⏳ **新しくグループを作成** - 新しいグループの作成機能
- ⏳ **支援事業所を探す** - 介護施設、居宅介護支援、地域包括、デイサービス、訪問看護、訪問介護、相談支援事業、放課後デイ、共同生活援助、老人ホーム等

#### 4. マイページ機能
- ⏳ **通知** - システムからの通知の確認・管理
- ⏳ **設定** - アカウント設定、通知設定、プライバシー設定、外部カルテ連携設定
- ⏳ **プラン** - 無料プラン、パートナープランの管理

### 基盤機能（コア機能を支える）

- ✅ **ユーザー認証** - サインアップ/ログイン/ログアウト
- ✅ **ヘルスデータ記録** - 体重/血圧/運動/歩数/睡眠時間（健康計画ページで記録）
- ✅ **データエクスポート** - CSV形式でダウンロード
- ✅ **電子保存の三原則実装** - 真正性・見読性・保存性の技術的実装
- ✅ **監査ログ** - すべてのデータアクセスの記録（`audit_log`テーブル）
- ✅ **エラー監視** - Sentry連携
- ✅ **アクセス解析** - Vercel Analytics連携

### 将来実装予定（コア機能実装後の拡張）

- ⏳ **データ可視化** - グラフ・統計表示の強化
- ⏳ **同意管理** - データ利用の同意取得・管理（拡充）
- ⏳ **ブロックチェーン技術** - 重要な記録の不変性保証（真正性の強化）
- ⏳ **個人データ暗号化** - 追加のセキュリティ層
- ⏳ **カスタムドメイン** - 独自ドメインでの運用
- ⏳ **複数ロール対応** - 1ユーザーが複数のロールを持つ場合の対応（将来検討）

---

## ❌ 非目標（やらないこと）

以下の機能は**絶対に実装しない**：

- ❌ **医療行為の自動化** - 医療は専門家の領域
- ❌ **診断の確定** - AIは診断を下さない
- ❌ **同意なきデータ連携** - 本人の同意が必須
- ❌ **個人識別可能情報の外部共有（同意なし）** - 個人情報は外部に出さない
- ❌ **データの外部送信（本人の明示的同意なし）** - データはユーザーのもの
- ❌ **広告/販売目的でのデータ利用** - 主権を侵害し、目的外利用となる
- ❌ **経済・政治的意思決定の自動化** - 個人主権と中立性を損ねるリスクが高い

---

## 🧭 迷ったときの判断基準

開発・運用で迷ったときは、この問いに立ち返る：

```
「それは本人の主権を強めるか？」
```

- **YES** → 実装する
- **NO** → 実装しない

### 具体例

| 機能案                   | 判断   | 理由                               |
| ------------------------ | ------ | ---------------------------------- |
| データエクスポート機能   | ✅ YES | ユーザーが自分のデータを取り出せる |
| 同意管理機能             | ✅ YES | ユーザーが自分で同意を管理できる   |
| 第三者へのデータ販売     | ❌ NO  | ユーザーの主権を侵害する           |
| デフォルトでデータ共有ON | ❌ NO  | 明示的同意なしの利用               |

---

## 🎯 成功指標（例）

### Beneficiary Platform
- **外部カルテ連携**: 連携医療機関数、データ同期成功率、同期エラー率
- **患者中心の医療**: データ所有権の実現率、データ共有同意率、データアクセス頻度
- **個別化医療・予防医療**: AI提案プランの実行率、リスク予測の精度、予防計画の達成率
- **遠隔医療・mHealth**: ウェアラブルデバイス連携率、モバイルアプリ利用率
- **ビッグデータ分析**: 医療アウトカム改善率、分析精度向上率
- 習慣化コミュニティ参加者の継続率
- 支援事業所マッチングの成功率

### 共通指標
- 電子保存の三原則の遵守率（真正性・見読性・保存性）
- データエクスポートの利用率
- ユーザー満足度

---

## 📊 技術スタック

### 基盤

- **フレームワーク**: Next.js 14+ (App Router), TypeScript, React
- **認証**: Better Auth
- **ORM**: Drizzle ORM
- **データベース**: Supabase (PostgreSQL)

### UI

- **汎用UI**: shadcn/ui
- **リッチエディター**: Tiptap
- **コードハイライト**: Shiki
- **仮想スクロール**: virtua
- **AIチャット**: Vercel AI SDK
- **クライアントフェッチ**: SWR

### コード管理

- **ディレクトリ整理**: レイヤードアーキテクチャ
- **Lint**: ESLint（shadcn/ui の対応に合わせて Biome を検討）
- **Format**: Prettier（shadcn/ui の対応に合わせて Biome を検討）
- **モノリポ**: Turborepo

### BaaS

- **Storage**: Cloudflare R2
- **Database**: Supabase
- **Payment**: Stripe
- **Email**: Resend
- **API**: AI Gateway
- **Hosting**: Vercel
- **Cron**: Vercel Cron Jobs
- **Realtime**: Ably
- **Video**: Vimeo

### 運用

- **Monitoring**: Sentry
- **Analytics**: Vercel Analytics
- **CI**: GitHub Actions

### テスト

- **E2E**: Playwright
- **Unit**: Vitest

---

## 🔗 本番環境

| 項目           | URL                                                 |
| -------------- | --------------------------------------------------- |
| **本番サイト** | https://personal-health-os.vercel.app               |
| **GitHub**     | https://github.com/keifuinc-ctrl/personal-health-os |

---

## 📝 更新履歴

| 日付       | 内容                                                         |
| ---------- | ------------------------------------------------------------ |
| 2024-12-20 | 初版作成（MVP リリース時点）                                 |
| 2025-01-XX | Beneficiary Platform中心に再構築、外部カルテ連携を強化 |

---

## 最後に

Personal Health OS は、健康データの個人主権を実現するためのプロジェクトです。

この理念に共感し、守り続けることで、ユーザーに真に価値のあるプラットフォームを提供し続けます。

```
「自分の健康データは、自分のもの。」
```
